---
# Install Docker Engine
- name: Update cache
  apt:
    update_cache: yes
- name: Install apt-transport-https and ca-certificates
  apt:
    name: "{{item}}"
    state: latest
  with_items:
    - apt-transport-https
    - ca-certificates
- name: Add apt key
  apt_key:
    keyserver: hkp://ha.pool.sks-keyservers.net:80
    id: 58118E89F3A912897C070ADBF76221572C52609D
- name: Add docker.list
  command: echo "deb https://apt.dockerproject.org/repo ubuntu-trusty main" | sudo tee /etc/apt/sources.list.d/docker.list
- name: Update apt cache again
  apt:
    update_cache: yes
- name: Install Docker Engine
  apt:
    name: docker-engine
    state: latest
#  command: wget -qO- https://get.docker.com/ | sh
#  become: true
#  become_user: root
- name: Start Docker Service
  service:
    name: docker
    state: started
# Install Docker Compose
- name: Install python-pip
  apt:
    name: python-pip
    state: latest
- name: Install Docker Compose
  pip:
    name: docker-compose
- name: Create work directory (/home/ubuntu/docker)
  file:
    name: docker
    state: directory
- name: Create jenkins directory
  file:
    name: docker/jenkins_home
    state: directory
    recurse: yes
- name: Creat tomcat directory
  file:
    name: docker/tomcat
    state: directory
    recurse: yes
- name: Copy the compose file
  copy:
    src: files/ci-compose.yml
    dest: docker/docker-compose.yml
    mode: 0755
- name: Copy tomcat configurations
  copy:
    src: files/tomcat-users.xml
    dest: docker/tomcat/tomcat-users.xml
- name: Docker compose up
  become: true
  become_user: root
  docker_service:
    project_name: ci
#    project_src:  ci
#    state:  present
    definition:
      version: '2'
      services:
        jenkins:
          image: jenkins
          ports:
            - "8080:8080"
            - "50000:50000"
          volumes:
            - "/home/ubuntu/docker/jenkins_home:/var/jenkins_home"
          container_name: compose-jenkins

        artifactory:
          image: docker.bintray.io/jfrog/artifactory-oss
          ports:
            - "8081:8081"
          volumes:
            - /home/ubuntu/docker/artifactory/data:/var/opt/jfrog/artifactory/data
            - /home/ubuntu/docker/artifactory/logs:/var/opt/jfrog/artifactory/logs
            - /home/ubuntu/docker/artifactory/etc:/var/opt/jfrog/artifactory/etc
          container_name: compose-artifactory-oss

        sonarqube:
          image: sonarqube
          ports:
            - "9000:9000"
            - "9092:9092"
          container_name: compose-sonarqube

        tomcat:
          image: tomcat
          ports:
            - "8888:8080"
          volumes:
            - /home/ubuntu/docker/tomcat/tomcat-users.xml:/usr/local/tomcat/conf/tomcat-users.xml
          container_name: compose-tomcat
  register: vijay

- debug:
    var:  vijay
